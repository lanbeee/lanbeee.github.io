<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Azaan Scheduler for iOS Safari</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    button { font-size: 18px; padding: 10px 20px; }
    #status { margin-top: 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Azaan Scheduler</h1>
  <p>This scheduler is optimized for iOS Safari.</p>
  <button id="startButton">Start Scheduler</button>
  <div id="status">Status: Waiting for user action…</div>

  <script>
    // Global variables for the AudioContext and decoded audio buffers.
    let audioContext;
    let fajrBuffer, azaanBuffer;

    // Define prayer times (24‑hour format as strings).
    // Adjust the times as needed.
    const prayerTimes = [
      { name: "Fajr",    time: "06:45", audioSrc: "static/fajr.mp3" },
      { name: "Dhuhr",   time: "13:15", audioSrc: "static/azaan.mp3" },
      { name: "Asr",     time: "15:45", audioSrc: "static/azaan.mp3" },
      { name: "Maghrib", time: "18:20", audioSrc: "static/azaan.mp3" },
      { name: "Isha",    time: "21:45", audioSrc: "static/azaan.mp3" }
    ];

    // Forced playback durations (in seconds).
    // Fajr: 246 seconds; others: 130.7 seconds.
    const forcedDurations = {
      "Fajr": 246,
      "default": 130.7
    };

    // Utility: Load and decode an audio file from a given URL.
    function loadAudio(url) {
      return fetch(url)
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer));
    }

    // Calculate the next occurrence of each prayer time.
    // Returns an array of objects with { name, time (Date), audioSrc }.
    function computeNextPrayerTimes() {
      const now = new Date();
      return prayerTimes.map(prayer => {
        const [hours, minutes] = prayer.time.split(":").map(Number);
        let prayerDate = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate(),
          hours,
          minutes,
          0,
          0
        );
        if (prayerDate <= now) {
          // If the time has already passed today, schedule for tomorrow.
          prayerDate.setDate(prayerDate.getDate() + 1);
        }
        return { name: prayer.name, time: prayerDate, audioSrc: prayer.audioSrc };
      });
    }

    // Schedule playback for each prayer.
    function schedulePrayers() {
      const prayers = computeNextPrayerTimes();
      prayers.forEach(prayer => {
        const now = new Date();
        const delay = prayer.time.getTime() - now.getTime();
        console.log(`Scheduling ${prayer.name} in ${delay} ms`);
        setTimeout(() => {
          playPrayer(prayer);
          // Also, re-schedule the same prayer for every 24 hours.
          setInterval(() => playPrayer(prayer), 24 * 60 * 60 * 1000);
        }, delay);
      });
      document.getElementById("status").textContent = "Prayers scheduled.";
    }

    // Play the prayer audio using the Web Audio API.
    function playPrayer(prayer) {
      const source = audioContext.createBufferSource();
      // Choose the appropriate buffer.
      source.buffer = (prayer.name === "Fajr") ? fajrBuffer : azaanBuffer;
      source.connect(audioContext.destination);
      source.start();
      console.log(`${prayer.name} started at ${new Date().toLocaleTimeString()}`);

      // Force-stop playback after the specified duration.
      const duration = (prayer.name === "Fajr") ? forcedDurations["Fajr"] : forcedDurations["default"];
      source.stop(audioContext.currentTime + duration);
    }

    // Unlock and initialize the audio system on user tap.
    document.getElementById("startButton").addEventListener("click", () => {
      // Create (or resume) the AudioContext.
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      audioContext.resume().then(() => {
        document.getElementById("status").textContent = "Audio context unlocked. Loading audio files…";
        // Load both audio files concurrently.
        Promise.all([
          loadAudio("static/fajr.mp3"),
          loadAudio("static/azaan.mp3")
        ]).then(buffers => {
          [fajrBuffer, azaanBuffer] = buffers;
          document.getElementById("status").textContent = "Audio files loaded. Scheduling prayers…";
          schedulePrayers();
        }).catch(err => {
          console.error("Audio load error:", err);
          document.getElementById("status").textContent = "Error loading audio files.";
        });
      }).catch(err => {
        console.error("AudioContext error:", err);
        document.getElementById("status").textContent = "Error unlocking audio.";
      });
      // Hide the start button after unlocking.
      document.getElementById("startButton").style.display = "none";
    });
  </script>
</body>
</html>
