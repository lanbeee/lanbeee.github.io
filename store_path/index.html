<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Quick Grocery</title>
    <style>
      :root {
        --bg: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --accent: #0ea5e9;
        --error: #b00020;
        --warn-bg: #fff7ed;
        --warn-border: #fdba74;
        --pill: #f3f4f6;
        --green: #10b981;
        --yellow: #ffff00;
        --red: #ef4444;
        --radius: 12px;
        --gap-sm: 8px;
        --gap-md: 12px;
        --gap-lg: 16px;
      }

      * { box-sizing: border-box; }

      html, body { height: 100%; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color: var(--text);
        background: var(--bg);
        line-height: 1.45;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: clamp(12px, 3vw, 20px);
      }

      h1 {
        font-size: clamp(20px, 4vw, 28px);
        margin: 0 0 var(--gap-sm) 0;
      }

      .subtle {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: var(--gap-md);
      }

      .control-group { margin: var(--gap-md) 0; }

      /* Small a11y improvement: the label was empty */
      .visually-hidden {
        position: absolute !important;
        width: 1px; height: 1px;
        padding: 0; margin: -1px;
        overflow: hidden; clip: rect(0, 0, 0, 0);
        white-space: nowrap; border: 0;
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }

      textarea {
        width: 100%;
        min-height: 120px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 16px;
        resize: vertical;
      }

      button {
        width: 100%;
        padding: 14px 16px;
        font-weight: 700;
        font-size: 16px;
        border-radius: var(--radius);
        border: 1px solid var(--accent);
        background: var(--accent);
        color: #fff;
        cursor: pointer;
        transition: transform 0.02s ease;
        margin-bottom: 1em;
      }
      button:active { transform: scale(0.99); }

      .status {
        margin: var(--gap-sm) 0;
        color: #374151;
        font-size: 14px;
        display: none; /* hidden until used */
      }
      .status.error { color: var(--error); }

      .panel {
        border: 1px solid var(--border);
        border-radius: calc(var(--radius) + 2px);
        padding: var(--gap-md);
        background: #fff;
        box-shadow: 0 1px 0 rgba(0,0,0,0.03);
      }
      /* Consistent vertical spacing between stacked panels */
      .panel + .panel { margin-top: var(--gap-md); }

      .panel h3 {
        margin: 0 0 6px 0;
        font-size: 18px;
      }

      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--pill);
        border: 1px solid var(--border);
        font-size: 12px;
      }

      .muted { color: var(--muted); }
      .small { font-size: 12px; }

      #canvas {
        width: 100%;
        height: auto;
        display: none;
        margin-top: var(--gap-md);
        border: 1px solid var(--border);
        border-radius: var(--radius);
      }

      .legend {
        margin-top: var(--gap-sm);
        font-size: 14px;
        color: #333;
        display: flex;
        gap: var(--gap-lg);
        flex-wrap: wrap;
      }
      .legend span {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .legend i {
        width: 12px; height: 12px;
        border-radius: 50%;
        border: 1px solid #222;
        display: inline-block;
      }
      .legend .entrance i { background: #00ff00; }
      .legend .stop i { background: #ffff00; }
      .legend .path i {
        background: #ff0000;
        border-radius: 2px;
        width: 18px; height: 4px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: var(--gap-sm);
      }
      th, td {
        padding: 10px 8px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        font-size: 15px;
        vertical-align: middle;
      }
      th {
        font-size: 13px;
        color: var(--muted);
        font-weight: 600;
      }
      td.stop-number {
        font-weight: 700;
        color: var(--accent);
        text-align: center;
      }

      select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        font-size: 14px;
      }

      tr.needs-category { background: var(--warn-bg); }
      tr.needs-category td { border-bottom: 1px solid var(--warn-border); }

      .warning-text {
        color: #9a3412;
        background: #fff7ed;
        border: 1px solid #fdba74;
        padding: 8px 10px;
        border-radius: 10px;
        margin-top: var(--gap-sm);
        font-size: 13px;
      }

      .grid {
        display: grid;
        gap: var(--gap-md);
        grid-template-columns: 1fr;
      }

      .top-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        margin: var(--gap-sm) 0 0 0;
      }
      .top-actions button { margin-bottom: 0; }

      .bottom-action { margin-top: var(--gap-lg); }

      /* utility to replace inline style on merged-panel */
      .mt-md { margin-top: var(--gap-md); }

      @media (min-width: 820px) {
        .grid { grid-template-columns: 1fr 1fr; }
        button { width: auto; min-width: 220px; }
        .bottom-action { text-align: right; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="panel">
        <h1>Plan quickest in-store route — enter your items below</h1>

        <div class="control-group">
          <label class="visually-hidden" for="item-input">Shopping items</label>
          <textarea
            id="item-input"
            placeholder="e.g.,&#10;Organic Bananas&#10;Milk&#10;Bread&#10;Toilet paper"
          ></textarea>
        </div>

        <div class="top-actions">
          <button id="go-btn">Generate Route</button>
          <div class="small muted" id="map-status">
            Map: <code>walmart_map.JPG</code>
          </div>
        </div>
      </div>

      <div id="output-container" class="panel">
        <h3>Map & Route</h3>
        <p id="status-message" class="status">Result will be here</p>
        <canvas id="canvas"></canvas>
        <div class="legend">
          <span class="entrance"><i></i>Entrance</span>
          <span class="stop"><i></i>Category Stops</span>
          <span class="path"><i></i>Path</span>
        </div>
      </div>

      <div class="panel mt-md" id="merged-panel" style="display: none">
        <div class="bottom-action">
          <button id="redraw-btn">Redraw Route</button>
        </div>
        <h3 id="summary-title">Shopping List & Route</h3>

        <div class="warning-text" id="unclassified-warning" style="display: none">
          Some items could not be confidently classified. Please choose a
          category for each highlighted row, then press <b>Redraw Route</b>.
        </div>

        <table>
          <thead id="editor-head"></thead>
          <tbody id="editor-body"></tbody>
        </table>
      </div>
    </div>

    <script>
      /* ---------------------------- Config & Data ---------------------------- */
      const ENTRANCE = { x: 338, y: 33 };
      const CHECKOUT = { x: 620, y: 265 };
      const categories = {
            "Fresh Produce": ["apple", "banana", "carrot", "lettuce", "grapes", "onion", "tomato", "cucumber", "strawberry", "spinach", "broccoli", "pear", "peach", "orange", "avocado", "potato"
              ,"fruit", "vegetable", "salad", "melon", "kiwi", "mango", "pineapple", "watermelon", "cabbage", "cauliflower", "celery", "corn", "eggplant", "garlic", "leek", "mushroom", "pepper", "radish", "squash", "zucchini", "asparagus", "artichoke", "beet", "brussels sprouts", "chard", "cherry", "clementine", "fig", "grapefruit", "honeydew", "nectarine", "papaya", "plum", "pomegranate", "raspberry", "tangerine"
              ,"herb", "cilantro", "parsley", "basil", "mint", "dill", "rosemary", "thyme", "oregano", "sage", "chives", "lavender", "lemongrass"
            ],
            "Frozen": ["frozen", "ice cream", "pizza", "fries", "veggies", "popsicle", "lasagna", "frozen dinner", "fish sticks", "nuggets"
              ,"frozen fruit", "frozen vegetable", "frozen meal", "frozen entree", "frozen appetizer", "frozen breakfast", "frozen dessert", "frozen yogurt", "ice cream sandwich", "sorbet", "gelato", "frozen pie", "frozen cake", "frozen cookie dough", "frozen waffle", "frozen pancake", "frozen burrito", "frozen taco", "frozen meatball", "frozen sausage", "frozen chicken tenders", "frozen fish fillet",
              "frozen shrimp", "frozen crab", "frozen lobster", "frozen seafood", "frozen vegetable mix", "frozen fruit mix", "frozen smoothie", "frozen juice", "frozen cocktail", "frozen margarita", "frozen daiquiri", "frozen piña colada"
            ],
            "Grocery": ["rice", "flour", "oil", "pasta", "canned", "sugar", "spices", "cereal", "beans", "soup", "sauce", "ketchup", "mustard"
              ,"bread crumbs", "baking powder", "baking soda", "brown sugar", "cornstarch", "couscous", "croutons", "dried fruit", "granola", "honey", "jam", "jelly", "maple syrup", "molasses", "nut butter", "oats", "peanut butter", "pita bread", "popcorn kernels", "quinoa", "salsa", "soy sauce", "syrup", "tortilla chips", "vinegar", "walnuts", "yeast",
              "canned beans", "canned corn", "canned fruit", "canned vegetables", "canned tuna", "canned chicken", "canned salmon", "canned soup", "canned chili", "canned stew", "canned pasta sauce", "canned tomato sauce", "canned coconut milk",
              "instant noodles", "ramen noodles", "macaroni and cheese", "instant rice", "instant oatmeal",
              "pasta sauce", "alfredo sauce", "marinara sauce", "pesto sauce", "barbecue sauce", "hot sauce", "salad dressing", "mayonnaise", "pickles", "olives", "capers",
              "spaghetti", "fettuccine", "penne", "rotini", "linguine", "macaroni", "lasagna noodles", "angel hair pasta", "canned soup", "canned broth", "canned stock",
              "canned beans", "canned lentils", "canned chickpeas", "canned black beans", "canned kidney beans", "canned pinto beans", "canned refried beans", "canned baked beans", "canned chili beans", "canned green beans", "canned peas", "canned carrots", "canned mushrooms", "canned potatoes", "canned yams", "canned pumpkin",
              "evaporated milk", "condensed milk", "coconut milk", "almond milk", "soy milk", "oat milk", "rice milk", "cashew milk", "hemp milk", "flax milk",
              "powdered milk", "dry milk", "instant milk", "non-dairy creamer", "coffee creamer", "whipped topping",
            ],
            "Snacks and Beverages": ["chips", "soda", "cookies", "juice", "snack", "pepsi", "coke", "candy", "crackers", "popcorn", "gatorade", "monster", "red bull", "fanta", "sprite", "7up", "dr pepper", "root beer", "ginger ale", "tonic water", "club soda", "energy drink", "sports drink", "canada dry", "seltzer water", "diet coke", "diet pepsi", "diet soda", "bottled water", "mineral water", "flavored soda", "fruit punch", "lemon-lime soda", "cola", "orange soda", "grape soda", "cream soda", "chocolate milk", "almond milk drink", "soy milk drink", "iced latte", "frappuccino",
              "water", "tea", "coffee", "energy drink", "trail mix", "granola bar", "protein bar", "fruit snack", "beef jerky", "nuts", "seeds", "dried fruit", "rice cake", "pudding cup", "yogurt cup", "cheese stick", "fruit cup", "applesauce cup",
              "sparkling water", "flavored water", "coconut water", "sports drink", "vitamin water", "lemonade", "iced coffee", "dairy milk", "reese's", "snickers", "twix", "kit kat", "m&ms", "hershey's", "milky way", "butterfinger", "almond joy", "3 musketeers", "candy bar", "gummy bears", "gummy worms", "licorice", "lollipop", "jawbreaker", "candy cane", "chocolate bar", "chocolate chip cookie", "oatmeal cookie", "sugar cookie", "peanut butter cookie", "shortbread cookie", "macaroon", "biscotti", "rice krispie treat", "poptart", "fig newton", "fruit leather",
              "roasted nuts", "salted nuts", "honey roasted nuts", "spicy nuts", "trail mix with chocolate", "trail mix with dried fruit", "trail mix with seeds", "protein bar with nuts", "protein bar with chocolate", "granola bar with yogurt coating",
              "iced tea", "bottled tea", "bottled coffee", "cold brew coffee",
              "hot chocolate mix", "instant coffee", "tea bags",
              "soda can", "soda bottle", "juice box", "juice pouch",
              "energy shot",
            ],
            "Dairy": ["milk", "cheese", "butter", "yogurt", "cream", "whipped cream", "cottage cheese","eggs", "half and half", "sour cream", "cream cheese", "feta cheese", "mozzarella cheese", "cheddar cheese", "parmesan cheese", "swiss cheese", "provolone cheese", "blue cheese", "goat cheese", "ricotta cheese", "colby jack cheese", "monterey jack cheese", "pepper jack cheese", "gouda cheese", "brie cheese", "camembert cheese", "mascarpone cheese", "quark cheese",
              "lactose-free milk", "almond milk", "soy milk", "oat milk", "coconut milk", "cashew milk", "rice milk", "hemp milk", "flax milk", "macadamia milk", "pea milk", "walnut milk", "hazelnut milk",
              "dairy-free yogurt", "plant-based yogurt", "dairy-free butter", "plant-based butter", "dairy-free cheese", "plant-based cheese",
            ],
            "Bakery": ["bread", "cake", "donut", "croissant", "bagel", "muffin", "rolls", "pastry", "cupcake", "pie"
              ,"white bread", "whole wheat bread", "multigrain bread", "sourdough bread", "rye bread", "pumpernickel bread", "ciabatta bread", "focaccia bread", "brioche bread", "naan bread", "tortilla", "flatbread", "baguette", "english muffin", "hot dog bun", "hamburger bun", "sub roll", "pretzel bun",
              "gluten-free bread", "gluten-free bagel", "gluten-free muffin", "gluten-free roll", "gluten-free pastry",
              "birthday cake", "chocolate cake", "vanilla cake", "red velvet cake", "carrot cake", "cheesecake", "fruitcake",
              "doughnut hole", "glazed doughnut", "chocolate doughnut", "jelly doughnut", "cruller", "old fashioned doughnut",
            ],
            "Meat and Seafood": ["chicken", "beef", "pork", "fish", "shrimp", "steak", "salmon", "tuna", "bacon", "crab", "lobster"
              ,"ground beef", "ground turkey", "ground chicken", "ground pork", "chicken breast", "chicken thigh", "chicken drumstick", "chicken wing", "whole chicken", "pork chop", "pork loin", "pork shoulder", "pork ribs", "beef steak", "beef roast", "beef ribs", "lamb chop", "lamb roast",
              "salmon fillet", "tilapia fillet", "cod fillet", "halibut fillet", "trout fillet", "catfish fillet", "sea bass fillet",
              "shrimp cocktail", "shrimp scampi", "crab legs", "crab cakes", "lobster tail", "lobster roll",
              "sausage", "hot dog", "bratwurst", "chorizo", "andouille sausage",
              "deli meat"
            ],
            "Deli": ["sandwich", "ham", "salami", "turkey", "wrap", "sub", "deli meat", "roast beef"
              ,"cold cut", "cold cut platter", "charcuterie board", "cheese platter", "fruit platter", "veggie platter",
              "potato salad", "macaroni salad", "coleslaw", "pasta salad", "green salad", "caesar salad", "garden salad",
              "hummus platter", "antipasto platter", "sushi platter", "sushi roll", "sashimi", "nigiri", "temaki", "california roll", "spicy tuna roll", "philadelphia roll", "dragon roll", "rainbow roll",
            ],
            "Pets": ["dog", "cat", "pet food", "litter", "treats", "kibble", "aquarium", "leash", "toys"
              ,"dog food", "cat food", "pet treats", "dog treats", "cat treats", "puppy food", "kitten food", "senior dog food", "senior cat food",
              "dry dog food", "dry cat food", "wet dog food", "wet cat food", "grain-free dog food", "grain-free cat food", "organic dog food", "organic cat food",
              "dog chew toy",
            ],
            "Cleaning": ["detergent", "disinfectant", "bleach", "soap", "mop", "wipes", "cleaner", "sanitizer", "polish","detergent", "fabric softener", "stain remover", "bleach", "cleaning cloths", "microfiber cloths", "sponges", "scrub pads", "toilet cleaner", "glass cleaner", "floor cleaner", "all-purpose cleaner",
              "laundry booster", "color catcher", "wrinkle releaser", "fabric refresher", "dryer balls", "scent booster", "laundry scent beads", "laundry detergent pods", "dish soap", "dishwasher detergent", "dishwasher rinse aid", "dishwasher cleaner", "garbage disposal cleaner", "kitchen cleaner", "bathroom cleaner", "tile cleaner", "grout cleaner", "mold and mildew remover", "air freshener", "odor eliminator",
              "broom", "dustpan", "vacuum cleaner", "carpet cleaner", "steam cleaner", "mop bucket", "spray mop", "floor scrubber", "pressure washer",
            ],
            "House Supplies": ["paper towels", "toilet paper", "trash bags", "foil", "napkins", "plastic wrap", "plates", "cups",
              "disposable plates", "disposable cups", "disposable utensils", "plastic cutlery", "paper napkins", "paper towels", "toilet paper rolls", "facial tissues", "kitchen towels", "cleaning wipes", "disinfecting wipes", "garbage bags", "recycling bags", "compost bags", "aluminum foil", "plastic wrap", "wax paper", "parchment paper", "baking cups", "baking liners", "cake boards", "cupcake liners", "food storage bags", "food storage containers", "plastic containers", "glass containers", "silicone bags", "beeswax wraps",
              "disposable gloves", "rubber gloves", "cleaning gloves", "latex gloves", "nitrile gloves", "vinyl gloves", "dishwashing gloves", "household gloves"
            ],
            "Office Supplies": ["pen", "pencil", "notebook", "paper", "stapler", "marker", "highlighter", "binder", "envelope"
              ,"sticky notes", "index cards", "file folders", "hanging file folders", "file box", "file cabinet", "desk organizer", "desk lamp", "paper clips", "binder clips", "rubber bands", "tape dispenser", "scotch tape", "masking tape", "packing tape", "glue stick", "white-out", "correction tape", "calculator", "calendar", "planner", "address book",
              "printer paper", "copy paper", "photo paper", "cardstock paper", "colored paper", "construction paper",
              "envelopes", "bubble mailers", "shipping labels", "postage stamps", "mailing tubes", "address labels", "return address labels",
            ],
            "Electronics": ["phone", "laptop", "tv", "camera", "tablet", "charger", "headphones", "speaker", "monitor", "keyboard", "mouse"
              ,"phone case", "screen protector", "earbuds", "wireless charger", "power bank", "usb cable", "hdmi cable", "ethernet cable", "surge protector", "smartwatch", "fitness tracker", "bluetooth speaker", "smart home device", "smart light bulb", "smart plug", "smart thermostat",
              "laptop bag", "laptop sleeve", "laptop stand", "monitor stand", "keyboard cover", "mouse pad",
              "camera lens", "camera tripod", "camera bag", "memory card", "external hard drive", "usb flash drive",
              "tv mount", "tv stand", "tv antenna", "streaming device", "dvd player", "blu-ray player", "gaming console", "video game", "controller", "headset"
            ],
            "Toys": ["lego", "doll", "puzzle", "game", "playset", "action figure", "plush", "board game",
              "building blocks",  "remote control car", "train set", "action figure", "dollhouse", "puzzle", "board game", "card game", "outdoor toy", "water gun", "frisbee", "kite", "jump rope", "hula hoop", "play tent", "sandbox", "ride-on toy", "scooter", "skateboard", "roller skates", "bicycle", "tricycle", "balance bike", "baby walker", "musical toy", "educational toy", "art supplies", "craft kit", "science kit", "robot kit", "building set", "lego set", "action figure set", "doll set", "plush toy", "stuffed animal", "puppet", "marionette", "toy car", "toy truck", "toy airplane", "toy boat"
              ,"exploding kittens", "catan", "monopoly", "clue", "risk", "scrabble", "ticket to ride", "carcassonne", "pandemic", "codenames", "7 wonders", "azul", "splendor", "dixit", "mysterium", "kingdomino", "sushi go", "love letter", "ludo", "chess", "checkers", "backgammon", "go", "mahjong", "dominoes", "jenga", "connect 4", "operation", "twister", "battleship"
            ],
            "Sports": ["ball", "bat", "soccer", "basketball", "tennis", "fitness", "weights", "yoga", "treadmill", "golf"
              ,"bicycle", "helmet", "gloves", "knee pads", "elbow pads", "wrist guards", "skateboard", "rollerblades", "scooter", "jump rope", "hula hoop", "frisbee", "kite", "water bottle", "gym bag", "towel", "sunscreen", "sunglasses", "hat", "cap", "visor", "running shoes", "cycling shoes", "cleats", "swimwear", "goggles", "swim cap", "towel", "yoga mat", "resistance bands", "foam roller", "exercise ball", "dumbbells", "kettlebells", "medicine ball", "pull-up bar", "ab roller", "fitness tracker", "heart rate monitor", "sports watch", "bike lock", "bike pump", "bike light", "bike computer", "bike rack", "golf clubs", "golf balls", "golf tees", "golf bag", "tennis racket", "tennis balls", "baseball glove", "baseball bat", "softball glove", "softball bat", "football", "soccer ball", "volleyball", "basketball hoop"
              ,"tent", "sleeping bag", "backpack", "hiking boots", "compass", "flashlight", "lantern", "camp stove", "cooler", "water bottle", "first aid kit", "insect repellent", "sunscreen", "map", "whistle", "multi-tool", "binoculars", "fishing rod", "fishing reel", "fishing line", "fishing tackle box", "fishing bait", "kayak", "canoe", "paddle", "life jacket", "swimsuit", "snorkel", "goggles", "diving mask", "surfboard", "bodyboard", "beach towel", "beach umbrella", "picnic blanket", "frisbee", "kite"
            ],
            "Baby": ["diaper", "formula", "stroller", "crib", "pacifier", "bottle", "wipes", "highchair", "car seat", "onesie", "baby food", "changing pad", "baby monitor", "teething toy"
              ,"wipes", "diaper rash cream", "baby lotion", "baby shampoo", "baby powder", "baby oil", "baby wash", "diaper bag", "changing table", "baby swing", "bouncer", "play mat", "activity gym", "teether", "rattle", "baby toy", "crib mattress", "crib sheets", "bassinet", "pack and play", "baby carrier", "nursing pillow", "breast pump", "nursing pads", "bottle warmer", "bottle sterilizer", "formula dispenser", "baby food maker", "baby utensils", "sippy cup", "high chair cover",
              "stroller organizer", "baby gate", "corner guards", "cabinet locks", "outlet covers", "baby proofing kit", "bib", "burp cloth", "swaddle", "sleep sack", "baby blanket", "baby clothes", "baby shoes", "carters", "gerber", "huggies", "pampers"
            ],
            "Girls": ["dress", "skirt", "leggings", "top", "blouse", "scarf", "handbag", "hair bow", "hair clip", "hair band", "school uniform"],
            "Boys": ["shorts", "tshirt", "hoodie", "jeans", "sweater"],
            "Mens": ["shirt", "pants", "suit", "jacket", "tie", "belt", "blazer"],
            "Mens Shoes": ["sneakers", "boots", "loafers", "sandals", "dress shoes", "oxfords", "slippers", "work boots", "running shoes", "hiking boots"],
            "Womens": ["blouse", "skirt", "dress", "leggings", "handbag", "scarf"],
            "Womens Shoes": ["heels", "sandals", "flats", "boots", "wedges"],
            "Jewelery": ["ring", "necklace", "bracelet", "earrings", "jewelry", "pendant"],
            "Arts and Crafts": ["paint", "glue", "scissors", "markers", "yarn", "clay", "beads", "paper craft"
              ,"sketchbook", "canvas", "easel", "paintbrush", "acrylic paint", "watercolor paint", "oil paint", "charcoal", "pastels", "colored pencils", "drawing pencils", "ink pens", "calligraphy pens", "markers", "highlighters", "glue stick", "liquid glue", "tape", "scissors", "craft knife", "cutting mat", "ruler", "stencil", "rubber stamps", "ink pad", "stickers", "washi tape", "yarn", "knitting needles", "crochet hook", "embroidery floss", "sewing kit", "fabric paint", "fabric markers", "beads", "jewelry wire", "jewelry pliers", "clay sculpting tools"
              ,"modeling clay", "polymer clay", "air dry clay", "ceramic clay", "pottery wheel", "kiln", "glazing supplies", "mosaic tiles", "glass cutting tools", "stained glass supplies"
            ],
            "Party Supplies": ["balloon", "decorations", "banner", "streamers", "candles", "party hats", 
              "confetti", "tablecloth", "napkins", "plates", "cups", "utensils", "gift bag", "wrapping paper", "ribbon", "tape", "gift tag", "invitation", "thank you card", "party favor", "pinata", "cake topper", "cupcake liner", "cake stand", "drink dispenser", "cooler", "ice bucket", "photo booth props", "party lights", "music playlist"
            ],
            "Seasonal": ["christmas", "halloween", "easter", "thanksgiving", "holiday", "ornament", "costume"
              ,"christmas tree", "christmas lights", "christmas wreath", "christmas garland", "christmas stocking", "christmas ornament", "christmas centerpiece", "christmas village", "christmas nativity set",
              "halloween costume", "halloween decoration", "halloween lights", "halloween wreath", "halloween centerpiece", "halloween party supplies",
              "easter basket", "easter eggs", "easter grass", "easter decoration", "easter centerpiece",
              "thanksgiving decoration", "thanksgiving centerpiece", "thanksgiving tableware",
              "fireworks", "patriotic decoration", "4th of july decoration", "memorial day decoration", "labor day decoration",
              "valentine's day decoration", "valentine's day card", "valentine's day gift",
              "st. patrick's day decoration", "st. patrick's day hat",
              "mother's day gift", "father's day gift",
              "birthday decoration", "birthday banner", "birthday cake topper",
              "new year's eve decoration", "new year's eve party supplies"
            ],
            "Home": ["sofa", "table", "lamp", "rug", "curtain", "mirror", "decor", "shelf", "cabinet", "desk", "bed", "dresser", "couch", "wardrobe",
              "picture frame", "vase", "clock", "candle", "throw pillow", "blanket", "plant", "artwork", "wall art", "photo album", "coasters", "tray", "basket", "storage box", "file organizer", "mail sorter", "key holder", "shoe rack", "umbrella stand", "coat rack", "entryway bench", "hall tree"
            ],
            "Kitchen": ["pan", "pot", "knife", "spoon", "blender", "mixer", "cup", "plate", "microwave", "toaster", "oven", "stove", "dishwasher", "cutting board", "measuring cup", "measuring spoon", "colander", "strainer", "grater", "peeler", "whisk", "tongs", "ladle", "spatula", "baking sheet", "casserole dish", "mixing bowl", "food processor", "slow cooker", "pressure cooker", "rice cooker", "air fryer", "coffee maker", "kettle",
              "can opener", "bottle opener", "corkscrew", "salad spinner", "ice cube tray", "thermometer", "timer", "apron", "oven mitts", "pot holders", "trivet", "food storage container", "plastic wrap", "aluminum foil", "wax paper", "baking paper", "kitchen scale", "recipe book", "cookbook stand", "spice rack", "knife block", "dish drying mat",
              "dish rack", "soap dispenser", "sponge holder", "trash can", "knives block", "utensil holder", "paper towel holder", "napkin holder", "spice rack", "recipe book stand", "kitchen scale", "bread box", "cookie jar", "water filter pitcher"
            ],
            "Laundry": [ "laundry basket", "dryer sheets", "iron", "ironing board", "clothes hangers", "hamper",
              "clothes pins", "drying rack", "laundry bag", "mesh laundry bag", "delicates bag", "garment steamer",
              "ironing spray", "sizing spray", "fabric refresher", "lint roller", "sewing kit"
            ],
            "Furniture": ["chair", "desk", "cabinet", "bed", "dresser", "couch", "wardrobe" , "sofa", "table", "lamp", "rug", "curtain", "mirror", "decor", "shelf", "dresser", "nightstand", "coffee table", "end table", "bookcase", "entertainment center", "tv stand", "ottoman", "bench", "stool", "armchair", "recliner", "futon", "sectional sofa",
              "dining table", "dining chair", "bar stool", "kitchen island", "kitchen cart", "vanity", "hall tree", "coat rack", "shoe rack", "storage bench", "storage ottoman",
              "recliner", "reclining chair", "loveseat", "sofa bed", "tv stand", "media console", "entertainment center", "china cabinet", "curio cabinet", "display cabinet", "buffet table", "sideboard", "console table"],
            "Bedding": ["pillow", "blanket", "comforter", "sheets", "duvet", "mattress", "bed frame", "bed skirt", "throw", "quilt", "fitted sheet", "flat sheet", "pillowcase", "mattress protector", "bedspread", "bed cover", "bed set", "bed-in-a-bag", "bed pillow", "euro sham", "decorative pillow", "body pillow", "throw blanket", "weighted blanket", "electric blanket", "heating blanket", "cooling blanket", "memory foam mattress", "latex mattress", "innerspring mattress", "hybrid mattress", "adjustable bed frame",
              "bedside", "nightstand", "headboard", "footboard", "bed canopy", "bed tray", "bed caddy", "mattress topper", "pillow top", "bed riser",
              "loft bed", "bunk bed", "trundle bed", "daybed", "futon", "sofa bed"],
            "Bath and shower": ["towel", "shower curtain", "bath mat", "soap dish", "toothbrush holder", "mirror", "scale", "toilet brush", "plunger", "trash can", "bathrobe", "loofah", "shower caddy", "washcloths", "liners", "tub", "hooks", "shampoo rack"],
            "Health": ["vitamin", "supplement", "bandage", "thermometer", "pain reliever", "ibuprofen", "aspirin", "medication", "cough syrup", "first aid", "ointment", "antibiotic", "medicine",
              "eye drops", "ear drops", "nasal spray", "inhaler", "allergy relief", "cold medicine", "flu medicine", "digestive aid", "probiotic", "antacid", "laxative", "anti-diarrheal", "antifungal", "antiseptic", "hydrocortisone", "calamine lotion", "foot powder",
              "muscle rub", "heat pack", "cold pack", "ice pack", "hot water bottle", "heating pad", "massager", "blood pressure monitor", "glucose meter", "cholesterol tester", "pulse oximeter", "CPR mask", "first aid kit"],
            "Personal Care": ["body wash", "shampoo", "conditioner", "soap", "toothpaste", "toothbrush", "deodorant", "razor", "shaving cream", "lotion", "mouthwash", "floss", "moisturizer"],
            "Beauty": ["makeup", "lipstick", "foundation", "mascara", "eyeliner", "nail polish", "perfume", "cologne", "style", "hair spray", "hair gel", "dye",
              "brush", "comb", "curler", "straightener", "blow dryer", "tweezers",  "cotton pads", "cotton swabs", "face mask", "scrub", "serum", "cleanser",
              "toner", "exfoliator", "sunscreen", "aftershave", "hair color", "nail file", "nail clippers", "cuticle pusher", "makeup remover"],
            "Hardware": ["screwdriver", "hammer", "drill", "wrench", "pliers", "nails", "screws", "saw", "tape measure", "level", "bolt", "nut", "washer", "ladder", "flashlight", "batteries", "extension cord", "glue gun", "plumbing",
              "electrical", "toolbox", "workbench", "vise", "clamp", "chisel", "file", "sandpaper", "paintbrush", "roller", "drop cloth", "safety glasses", "ear protection", "dust mask", "work gloves", "tool belt",
              "caulk", "sealant", "insulation", "lumber", "pipe", "fitting", "valve", "hinge", "lock", "chain", "padlock", "cable", "rope", "hook", "bracket", "shelf bracket", "corner brace", "angle bracket"],
            "Paint": ["paint", "roller", "brush", "primer", "spray paint", "paint thinner", "drop cloth", "painter's tape", "stir stick", "paint tray", "sandpaper", "putty", "caulk", "wallpaper", "wall decal", "paint sprayer",
              "paint can opener", "paint edger", "paint shield", "paint roller extension", "paint roller cover", "paint roller frame", "paint roller tray liner",
              "paint roller cleaner", "paint roller spinner", "paint roller washer", "paint roller cage", "paint roller grid"],
            "Automotive": ["tire", "oil", "wiper", "car battery", "brake", "engine", "filter", "headlight", "taillight", "spark plug", "car wax", "car wash", "air freshener", "jumper cables", "car mat", "car cover", "car seat cover", "roof rack", "bike rack", "car jack", "lug wrench", "tire inflator", "tire pressure gauge", "car vacuum", "car polish", "car detailing kit", "car cleaning supplies",
              "motor oil", "transmission fluid", "coolant", "antifreeze", "power steering fluid", "brake fluid", "windshield washer fluid", "battery charger", "car diagnostic tool", "OBD-II scanner", "car repair manual", "car maintenance log", "car emergency kit",
              "windshield sunshade", "wiper blade", "car antenna", "car horn", "car mirror", "car light bulb", "car fuse", "car relay", "car belt", "car hose", "car clamp", "car pulley", "car gasket", "car seal", "car bushing", "car mount", "car bracket", "car spacer"],
            "Garden": ["shovel", "soil", "seeds", "fertilizer", "hose", "plants", "pots", "flower", "weed killer", "lawn mower", "rake", "pruner", "gloves", "watering can", "sprinkler", "garden decor", "garden statue", "bird feeder", "garden light", "garden tool set", "garden cart", "wheelbarrow", "compost bin", "garden netting", "garden trellis", "garden arch", "garden fence", "garden edging", "garden soil tester",
              "garden kneeler", "garden apron", "garden hat", "garden boots", "garden clogs", "garden shoes", "garden sandals", "garden socks", "garden umbrella", "garden shade cloth", "garden greenhouse", "garden cold frame", "garden potting bench", "garden storage shed",
              "showel", "trowel", "cultivator", "weeder", "garden fork", "garden hoe", "garden rake", "garden spade", "garden scissors", "garden shears", "garden loppers", "garden pruners", "garden saw", "garden chainsaw", "garden blower", "garden vacuum"],
        };
      const coordinates = { "Fresh Produce": { "x": 235, "y": 227 }, "Frozen": { "x": 235, "y": 356 }, "Grocery": { "x": 235, "y": 550 }, "Snacks and Beverages": { "x": 235, "y": 731 }, "Dairy": { "x": 235, "y": 899 }, "Bakery": { "x": 79, "y": 343 }, "Meat and Seafood": { "x": 105, "y": 550 }, "Deli": { "x": 105, "y": 783 }, "Pets": { "x": 416, "y": 822 }, "Cleaning": { "x": 519, "y": 822 }, "House Supplies": { "x": 571, "y": 822 }, "Office Supplies": { "x": 636, "y": 822 }, "Electronics": { "x": 817, "y": 822 }, "Toys": { "x": 1101, "y": 822 }, "Sports": { "x": 1295, "y": 822 }, "Baby": { "x": 461, "y": 640 }, "Girls": { "x": 636, "y": 653 }, "Boys": { "x": 745, "y": 653 }, "Mens": { "x": 720, "y": 414 }, "Mens Shoes": { "x": 720, "y": 537 }, "Womens": { "x": 480, "y": 446 }, "Womens Shoes": { "x": 506, "y": 524 }, "Jewelery": { "x": 403, "y": 524 }, "Arts and Crafts": { "x": 855, "y": 615 }, "Party Supplies": { "x": 855, "y": 518 }, "Seasonal": { "x": 855, "y": 408 }, "Home": { "x": 1062, "y": 679 }, "Kitchen": { "x": 1101, "y": 395 }, "Laundry": { "x": 1127, "y": 589 }, "Furniture": { "x": 998, "y": 621 }, "Bedding": { "x": 998, "y": 537 }, "Bath and shower": { "x": 998, "y": 446 }, "Health": { "x": 1024, "y": 278 }, "Personal Care": { "x": 1146, "y": 246 }, "Beauty": { "x": 1282, "y": 246 }, "Hardware": { "x": 1295, "y": 505 }, "Paint": { "x": 1295, "y": 505 }, "Automotive": { "x": 1295, "y": 666 }, "Garden": { "x": 1360, "y": 201 }, };


      /* ---------------------------- DOM Elements ---------------------------- */
      const itemInput = document.getElementById("item-input");
      const goBtn = document.getElementById("go-btn");
      const redrawBtn = document.getElementById("redraw-btn");
      const canvas = document.getElementById("canvas");
      const statusMessage = document.getElementById("status-message");
      const mapStatus = document.getElementById("map-status");
      const editorHead = document.getElementById("editor-head");
      const editorBody = document.getElementById("editor-body");
      const unclassifiedWarning = document.getElementById("unclassified-warning");
      const mergedPanel = document.getElementById("merged-panel");

      /* ------------------------------ Map Image ------------------------------ */
      let defaultMapImage = null;
      function tryLoadDefaultMap() {
        const img = new Image();
        img.onload = () => {
          defaultMapImage = img;
          mapStatus.textContent = "";
        };
        img.onerror = () => {
          defaultMapImage = null;
          mapStatus.textContent = "Map: walmart_map.JPG (missing).";
        };
        img.src = "walmart_map.JPG";
      }

      /* ------------------------------ Core Logic ---------------------------- */
      function handleGenerate() {
        const text = itemInput.value.trim().replace(/[,;]+/g, "\n");
        const items = text.split("\n").map(s => s.trim()).filter(Boolean);
        if (items.length === 0) {
          updateStatus("Please enter at least one grocery item.", true);
          return;
        }

        const classification = classifyItems(items);
        buildClassificationEditor(items, classification);

        mergedPanel.style.display = "block";
        handleRedraw();
      }

      function handleRedraw() {
        const selectedCategories = readSelectedCategories();
        const hasUnselected = selectedCategories.some(v => !v || v === "__choose__");

        if (hasUnselected) {
          unclassifiedWarning.style.display = "block";
          updateStatus("Please select categories for the highlighted items.", true);
          canvas.style.display = "none";
          return;
        }
        unclassifiedWarning.style.display = "none";

        const points = categoriesToPoints(selectedCategories);
        if (points.length === 0) {
          updateStatus("Could not find coordinates for any of the selected categories.", true);
          return;
        }

        renderAll(points);
      }

      /* -------------------------------- Events ------------------------------- */
      goBtn.addEventListener("click", handleGenerate);
      redrawBtn.addEventListener("click", handleRedraw);

      /* ------------------------------- Helpers ------------------------------- */
      function updateStatus(message, isError = false) {
        statusMessage.style.display = "block";
        statusMessage.textContent = message;
        statusMessage.className = isError ? "status error" : "status";
        if (isError) canvas.style.display = "none";
      }

      function distance(p1, p2) { return Math.hypot(p1.x - p2.x, p1.y - p2.y); }

      function totalPathDistance(orderedPoints) {
        let d = 0;
        for (let i = 1; i < orderedPoints.length; i++) d += distance(orderedPoints[i - 1], orderedPoints[i]);
        return d;
      }

      /* ---------------- TF-IDF Classification (unchanged) -------------------- */
      function tokenize(text) { return text.toLowerCase().match(/\b\w+\b/g) || []; }

      const docCount = Object.keys(categories).length;
      const df = {};
      for (const [cat, words] of Object.entries(categories)) {
        const uniqueTokens = new Set(words.map(w => w.toLowerCase()));
        for (const token of uniqueTokens) df[token] = (df[token] || 0) + 1;
      }

      function tfidfVector(words) {
        const tokens = tokenize(Array.isArray(words) ? words.join(" ") : words);
        const counts = {};
        tokens.forEach(t => (counts[t] = (counts[t] || 0) + 1));
        const vec = {};
        for (const [t, c] of Object.entries(counts)) {
          const idf = Math.log(docCount / (1 + (df[t] || 0)));
          vec[t] = c * idf;
        }
        return vec;
      }

      function cosineSim(vecA, vecB) {
        let dot = 0, normA = 0, normB = 0;
        const allTokens = new Set([...Object.keys(vecA), ...Object.keys(vecB)]);
        allTokens.forEach(t => {
          const a = vecA[t] || 0;
          const b = vecB[t] || 0;
          dot += a * b;
          normA += a * a;
          normB += b * b;
        });
        return dot / (Math.sqrt(normA) * Math.sqrt(normB) + 1e-10);
      }

      const categoryVectors = {};
      for (const [cat, words] of Object.entries(categories)) {
        categoryVectors[cat] = tfidfVector(words);
      }

      function bestCategoryWithScore(text) {
        const inputVec = tfidfVector(tokenize(text));
        let bestCat = null, bestScore = -Infinity;
        for (const [cat, vec] of Object.entries(categoryVectors)) {
          const score = cosineSim(inputVec, vec);
          if (score > bestScore) { bestScore = score; bestCat = cat; }
        }
        return { category: bestCat, score: bestScore };
      }

      function classifyItems(items) { return items.map(it => bestCategoryWithScore(it)); }

      /* ------------------------ UI Building Functions ------------------------ */
      function buildClassificationEditor(items, classification) {
        editorHead.innerHTML = `<tr><th style="width:5%">#</th><th style="width:50%">Item</th><th>Category</th></tr>`;
        editorBody.innerHTML = "";
        const allCats = Object.keys(categories).sort();

        items.forEach((item, i) => {
          const { category, score } = classification[i];
          const needsHuman = !(score >= 0.001);

          const tr = document.createElement("tr");
          tr.className = "item-row";
          tr.dataset.item = item;
          if (needsHuman) tr.classList.add("needs-category");

          const tdStop = document.createElement("td");
          tdStop.className = "stop-number";
          tr.appendChild(tdStop);

          const tdItem = document.createElement("td");
          tdItem.textContent = item;
          tr.appendChild(tdItem);

          const tdCat = document.createElement("td");
          const select = document.createElement("select");
          select.className = "cat-select";

          if (needsHuman) {
            const placeholder = Object.assign(document.createElement("option"), {
              value: "__choose__",
              textContent: "Select category…",
              disabled: true,
              selected: true,
            });
            select.appendChild(placeholder);
          }

          allCats.forEach(c => {
            const opt = Object.assign(document.createElement("option"), {
              value: c,
              textContent: c,
            });
            if (!needsHuman && c === category) opt.selected = true;
            select.appendChild(opt);
          });

          select.addEventListener("change", () => {
            tr.classList.remove("needs-category");
          });

          tdCat.appendChild(select);
          tr.appendChild(tdCat);
          editorBody.appendChild(tr);
        });
      }

      function updateEditorWithOrder(orderedPoints) {
        const coordToCat = Object.fromEntries(
          Object.entries(coordinates).map(([cat, { x, y }]) => [`${x}|${y}`, cat])
        );

        const orderedCategories = orderedPoints.slice(1, -1).map(p => coordToCat[`${p.x}|${p.y}`]);

        const rowsByCategory = {};
        editorBody.querySelectorAll("tr.item-row").forEach(tr => {
          const category = tr.querySelector("select.cat-select").value;
          if (category && category !== "__choose__") {
            if (!rowsByCategory[category]) rowsByCategory[category] = [];
            rowsByCategory[category].push(tr);
          }
        });

        const fragment = document.createDocumentFragment();
        orderedCategories.forEach((category, index) => {
          const stopNumber = index + 1;
          if (rowsByCategory[category]) {
            rowsByCategory[category].forEach(tr => {
              tr.querySelector(".stop-number").textContent = stopNumber;
              fragment.appendChild(tr);
            });
          }
        });

        editorBody.innerHTML = "";
        editorBody.appendChild(fragment);
      }

      function readSelectedCategories() {
        return Array.from(document.querySelectorAll(".cat-select")).map(s => s.value);
      }

      function categoriesToPoints(selectedCategories) {
        const unique = [...new Set(selectedCategories.filter(v => v && v !== "__choose__"))];
        return unique.map(cat => coordinates[cat]).filter(Boolean);
      }

      /* -------------------------- Path Algorithm ----------------------------- */
      function solveTsp(points) {
        const cities = dedupeAndStripEntrance(points);
        if (cities.length === 0) return [ENTRANCE, ENTRANCE];

        const OPTIMAL_LIMIT = 20; // exact Held–Karp up to 20 stops
        if (cities.length <= OPTIMAL_LIMIT) {
          const order = heldKarpTsp(cities);
          return [ENTRANCE, ...order, CHECKOUT];
        } else {
          console.warn(`> ${OPTIMAL_LIMIT} stops — using NN + 2-opt heuristic for speed.`);
          const order = twoOptImprove(nearestNeighborOrder(cities), cities);
          return [ENTRANCE, ...order.map(i => cities[i]), CHECKOUT];
        }
      }

      function heldKarpTsp(cities) {
        const n = cities.length;
        const dCity = Array.from({ length: n }, () => Array(n).fill(0));
        const dStart = Array(n).fill(0);
        const dEnd = Array(n).fill(0);
        for (let i = 0; i < n; i++) {
          dStart[i] = distance(ENTRANCE, cities[i]);
          dEnd[i] = distance(cities[i], CHECKOUT);
          for (let j = 0; j < n; j++) dCity[i][j] = distance(cities[i], cities[j]);
        }

        const size = 1 << n;
        const INF = 1e18;
        const dp = Array.from({ length: size }, () => Array(n).fill(INF));
        const parent = Array.from({ length: size }, () => Array(n).fill(-1));

        for (let i = 0; i < n; i++) {
          const m = 1 << i;
          dp[m][i] = dStart[i];
        }

        for (let mask = 1; mask < size; mask++) {
          for (let i = 0; i < n; i++) {
            if (!(mask & (1 << i))) continue;
            const prevMask = mask ^ (1 << i);
            if (prevMask === 0) continue;
            let best = dp[mask][i];
            let bestPrev = -1;
            for (let j = 0; j < n; j++) {
              if (!(prevMask & (1 << j))) continue;
              const cand = dp[prevMask][j] + dCity[j][i];
              if (cand < best) { best = cand; bestPrev = j; }
            }
            if (best < dp[mask][i]) { dp[mask][i] = best; parent[mask][i] = bestPrev; }
          }
        }

        const full = size - 1;
        let bestCost = INF, last = -1;
        for (let i = 0; i < n; i++) {
          const cand = dp[full][i] + dEnd[i];
          if (cand < bestCost) { bestCost = cand; last = i; }
        }

        const orderIdx = [];
        let mask = full, cur = last;
        while (cur !== -1) {
          orderIdx.push(cur);
          const p = parent[mask][cur];
          mask ^= 1 << cur;
          cur = p;
        }
        orderIdx.reverse();
        return orderIdx.map(i => cities[i]);
      }

      /* ---------- Fast fallback: NN + 2-opt ---------- */
      function nearestNeighborOrder(cities) {
        const n = cities.length;
        const used = Array(n).fill(false);
        let start = 0, best = Infinity;
        for (let i = 0; i < n; i++) {
          const d = distance(ENTRANCE, cities[i]);
          if (d < best) { best = d; start = i; }
        }
        const order = [start];
        used[start] = true;
        for (let k = 1; k < n; k++) {
          const last = order[order.length - 1];
          let bestJ = -1, bestD = Infinity;
          for (let j = 0; j < n; j++) {
            if (used[j]) continue;
            const d = distance(cities[last], cities[j]);
            if (d < bestD) { bestD = d; bestJ = j; }
          }
          order.push(bestJ);
          used[bestJ] = true;
        }
        return order;
      }

      function twoOptImprove(order, cities) {
        const n = order.length;
        if (n < 4) return order.slice();

        const tourLen = ord => {
          let sum = distance(ENTRANCE, cities[ord[0]]);
          for (let i = 1; i < ord.length; i++) sum += distance(cities[ord[i - 1]], cities[ord[i]]);
          sum += distance(cities[ord[ord.length - 1]], CHECKOUT);
          return sum;
        };

        let improved = true;
        let bestOrder = order.slice();
        let bestLen = tourLen(bestOrder);

        while (improved) {
          improved = false;
          for (let i = 0; i < n - 2; i++) {
            for (let k = i + 2; k < n; k++) {
              const newOrder = bestOrder.slice(0, i + 1)
                .concat(bestOrder.slice(i + 1, k + 1).reverse())
                .concat(bestOrder.slice(k + 1));
              const newLen = tourLen(newOrder);
              if (newLen + 1e-9 < bestLen) {
                bestOrder = newOrder;
                bestLen = newLen;
                improved = true;
              }
            }
          }
        }
        return bestOrder;
      }

      function getPermutations(arr) {
        if (arr.length === 0) return [[]];
        const firstEl = arr[0];
        const rest = arr.slice(1);
        const permsWithoutFirst = getPermutations(rest);
        const allPermutations = [];
        permsWithoutFirst.forEach(perm => {
          for (let i = 0; i <= perm.length; i++) {
            const permWithFirst = [...perm.slice(0, i), firstEl, ...perm.slice(i)];
            allPermutations.push(permWithFirst);
          }
        });
        return allPermutations;
      }

      function getNearestNeighborPath(cities) {
        const unvisited = [...cities];
        const path = [ENTRANCE];
        const distanceSq = (p1, p2) => {
          const dx = p1.x - p2.x, dy = p1.y - p2.y;
          return dx * dx + dy * dy;
        };
        while (unvisited.length > 0) {
          const current = path[path.length - 1];
          let bestIdx = 0, bestD = Infinity;
          for (let i = 0; i < unvisited.length; i++) {
            const d = distanceSq(current, unvisited[i]);
            if (d < bestD) { bestD = d; bestIdx = i; }
          }
          path.push(unvisited.splice(bestIdx, 1)[0]);
        }
        path.push(ENTRANCE);
        return path;
      }

      function dedupeAndStripEntrance(points) {
        const key = p => `${p.x}|${p.y}`;
        const entranceKey = key(ENTRANCE);
        const seen = new Set();
        const out = [];
        for (const p of points) {
          const k = key(p);
          if (k === entranceKey) continue;
          if (!seen.has(k)) {
            seen.add(k);
            out.push({ x: p.x, y: p.y });
          }
        }
        return out;
      }

      /* --------------------------- Rendering Logic --------------------------- */
      function renderAll(points) {
        if (!defaultMapImage) {
          updateStatus("Map image missing.", true);
          return;
        }
        const orderedPoints = solveTsp(points);
        drawImageAndPath(defaultMapImage, orderedPoints);
        updateEditorWithOrder(orderedPoints);
        const stops = Math.max(0, orderedPoints.length - 2);
        updateStatus(`Path generated through ${stops} stops`, false);
      }

      function drawImageAndPath(img, orderedPoints) {
        canvas.style.display = "block";
        canvas.style.width = "100%";
        canvas.style.height = "auto";

        const containerWidth = (canvas.parentElement && canvas.parentElement.clientWidth) || img.width;
        const displayWidth = Math.min(containerWidth, img.width);
        const scale = displayWidth / img.width;
        const displayHeight = img.height * scale;

        const DPR = Math.max(1, window.devicePixelRatio || 1);
        canvas.width = Math.round(displayWidth * DPR);
        canvas.height = Math.round(displayHeight * DPR);

        const ctx = canvas.getContext("2d");
        ctx.setTransform(DPR * scale, 0, 0, DPR * scale, 0, 0);
        ctx.clearRect(0, 0, img.width, img.height);

        ctx.drawImage(img, 0, 0, img.width, img.height);

        const base = Math.min(img.width, img.height);
        const lineWidth = Math.max(4, Math.round(base * 0.006));
        const pointRadius = Math.max(10, Math.round(lineWidth * 3));
        const entranceRadius = Math.round(pointRadius * 1.35);

        const T = p => ({ x: p.x, y: img.height - p.y });

        if (orderedPoints.length >= 2) {
          ctx.lineWidth = lineWidth;
          ctx.lineJoin = "round";
          ctx.lineCap = "round";
          ctx.strokeStyle = "#ef4444";
          ctx.beginPath();
          const start = T(orderedPoints[0]);
          ctx.moveTo(start.x, start.y);
          for (let i = 1; i < orderedPoints.length; i++) {
            const pt = T(orderedPoints[i]);
            ctx.lineTo(pt.x, pt.y);
          }
          ctx.stroke();
        }

        ctx.lineWidth = Math.max(2, Math.round(lineWidth * 0.6));
        ctx.strokeStyle = "#111827";
        orderedPoints.forEach((p, i) => {
          const tp = T(p);
          const isEntrance = i === 0 || i === orderedPoints.length - 1;
          ctx.beginPath();
          ctx.fillStyle = isEntrance ? "#10b981" : "#ffff00";
          ctx.arc(tp.x, tp.y, isEntrance ? entranceRadius : pointRadius, 0, 2 * Math.PI);
          ctx.fill();
          ctx.stroke();
        });
      }

      /* --------------------------------- Init -------------------------------- */
      (function init() {
        tryLoadDefaultMap();
      })();
    </script>
  </body>
</html>
